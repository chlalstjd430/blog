---
title: "[Kubernets/ì¿ ë²„ë„¤í‹°ìŠ¤] 03. ì¿ ë²„ë„¤í‹°ìŠ¤ ì…ë¬¸ - ì¸ê·¸ë ˆìŠ¤(ingress)"
date: 2020-09-12T00:07:29+09:00
categories: ["Kubernetes"]
tags: ["Devops"]
---

# ğŸ•¸ ì¿ ë²„ë„¤í‹°ìŠ¤ ì…ë¬¸ - ì¸ê·¸ë ˆìŠ¤ ğŸ•¸


ì´ì „ì— ë°°ìš´ NodePortë¡œ ì™¸ë¶€ ì„œë¹„ìŠ¤ë¥¼ ê³µê°œí•˜ëŠ” ê²ƒì€ L4 ë ˆë²¨ê¹Œì§€ë§Œ ë‹¤ë£° ìˆ˜ ìˆê¸° ë–„ë¬¸ì— HTTP/HTTPSì²˜ëŸ¼ ê²½ë¡œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì„œë¹„ìŠ¤ë¥¼ ì „í™˜í•˜ëŠ” L7 ë ˆë²¨ì˜ ì œì–´ëŠ” ë¶ˆê°€ëŠ¥í•˜ë‹¤.

ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ ë¦¬ì†ŒìŠ¤ê°€ **ì¸ê·¸ë ˆìŠ¤** ë‹¤. ê·¸ëŸ¬ë‚˜ ë¡œì»¬ ì¿ ë²„ë„¤í‹°ìŠ¤ í™˜ê²½ì—ì„œëŠ” ì¸ê·¸ë ˆìŠ¤ë¥¼ ì‚¬ìš©í•´ ì„œë¹„ìŠ¤ë¥¼ ë…¸ì¶œì‹œí‚¬ ìˆ˜ ì—†ë‹¤. í´ëŸ¬ìŠ¤í„°ì™¸ë¶€ì—ì„œ ì˜¨ HTTP ìš”ì²­ì„ ì„œë¹„ìŠ¤ë¡œ ë¼ìš°íŒ…í•˜ê¸° ìœ„í•œ niginx_ingress_controllerì„ ë‹¤ìŒê³¼ ê°™ì´ ë°°í¬í•œë‹¤.

~~~
$ kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v0.35.0/deploy/static/provider/cloud/deploy.yaml

...

job.batch/ingress-nginx-admission-create created
job.batch/ingress-nginx-admission-patch created
~~~

ê·¸ëŸ¬ë©´ ì ì‹œ í›„ ingress-nginxì— ë‹¤ìŒê³¼ ê°™ì€ ì„œë¹„ìŠ¤ì™€ íŒŒë“œê°€ ìƒì„±ëœë‹¤. ì´ì œ ì¸ê·¸ë ˆìŠ¤ ë¦¬ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

~~~
$ kubectl -n ingress-nginx get service,pod
NAME                                         TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE
service/ingress-nginx-controller             LoadBalancer   10.98.76.240    localhost     80:32634/TCP,443:31331/TCP   4m29s
service/ingress-nginx-controller-admission   ClusterIP      10.111.83.116   <none>        443/TCP                      4m29s

NAME                                            READY   STATUS      RESTARTS   AGE
pod/ingress-nginx-admission-create-lxkrf        0/1     Completed   0          4m29s
pod/ingress-nginx-admission-patch-4qqq4         0/1     Completed   2          4m29s
pod/ingress-nginx-controller-5947756d78-tsm56   1/1     Running     0          4m29s
~~~

<br><br>

## ì¸ê·¸ë ˆìŠ¤ë¥¼ í†µí•´ ì ‘ê·¼í•˜ê¸°

ì‹¤ì œë¡œ ì¸ê·¸ë ˆìŠ¤ë¥¼ í†µí•´ ì„œë¹„ìŠ¤ì— ì ‘ê·¼í•´ ë³´ê² ë‹¤. simple-service.yaml íŒŒì¼ì„ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •í•˜ê³  ë°˜ì˜í•´ë³´ì. spec.type ê°’ì€ ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´ ClusterIP ì„œë¹„ìŠ¤ê°€ ìƒì„±ëœë‹¤.

~~~yaml
apiVersion: v1
kind: Service
metadata:
  name: echo
spec:
  selector:
    app: echo
  ports:
  - name: http
    port: 80
~~~

~~~
$ kubectl apply -f simple-service.yaml
service/echo created
~~~

simple-ingress.yaml íŒŒì¼ì— ê°„ë‹¨í•œ ì¸ê·¸ë ˆìŠ¤ë¥¼ ì •ì˜í•˜ê³  ë°˜ì˜í•œë‹¤.

~~~yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: echo
spec:
  rules:
  - host: ch05.cms.local
    http:
      paths:
      - path: /
        backend:
          serviceName: echo
          servicePort: 80
~~~

~~~
$ kubectl apply -f simple-ingress.yaml
ingress.extensions/echo created

$ kubectl get ingress
NAME   HOSTS            ADDRESS   PORTS   AGE
echo   ch05.cms.local             80      20s
~~~

ì¸ê·¸ë ˆìŠ¤ëŠ” L7 ë¼ìš°íŒ…ì´ ê°€ëŠ¥í•˜ë¯€ë¡œ ê°€ìƒ í˜¸ìŠ¤íŒ… ê¸°ëŠ¥ì²˜ëŸ¼ ì €ì¥ëœ í˜¸ìŠ¤íŠ¸ í˜¹ì€ ê²½ë¡œì™€ ì¼ì¹˜í•˜ëŠ” ì„œë¹„ìŠ¤ë¡œ ìš”ì²­ì„ ì „ë‹¬í•  ìˆ˜ ìˆë‹¤.

ë¡œì»¬ì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ HTTP ìš”ì²­ì„ ë³´ë‚´ë©´ ë°±ì—”ë“œì— ìˆëŠ” echo ì„œë¹„ìŠ¤ì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ ì‘ë‹µì„ ë³´ë‚´ì˜¨ë‹¤. /etc/hostsì— ì¸ê·¸ë ˆìŠ¤ì—ì„œ ì •ì˜í•œ í˜¸ìŠ¤íŠ¸ë¥¼ 127.0.0.1ë¡œ ì •ì˜í•´ ê°™ì€ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤.

~~~
$ curl http://localhost -H 'Host: ch05.cms.local'
~~~

ì´ ì™¸ì—ë„ ì¸ê·¸ë ˆìŠ¤ ì¸µì—ì„œ HTTP ìš”ì²­ì— ë‹¤ì–‘í•œ ì œì–´ë¥¼ í•  ìˆ˜ ìˆë‹¤. ì˜ˆë¥¼ ë“¤ë©´, simple-ingress.yaml íŒŒì¼ì„ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •í•œë‹¤.

~~~
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: echo
  annotations:
    nginx.ingress.kubernetes.io/server-shippet: |
      set $agentflag 0;

      if ( $http_user_agent ~* "(Mobile)" ) {
        set $agentflag 1;
      }

      if ( $agentflag = 1) {
        return 301 http://cms.kr/;
      }
spec:
  rules:
  - host: ch05.cms.local
    http:
      paths:
      - path: /
        backend:
          serviceName: echo
          servicePort: 80
~~~

ë¡œì»¬ ì¿ ë²„ë„¤í‹°ìŠ¤ í™˜ê²½ì—ì„œëŠ” nginx-ingress-controllerë¥¼ ì‚¬ìš©í•œë‹¤. metadata.annotations íŒŒì¼ì— nginx-ingress-controller ìì²´ì˜ ì œì–´ ì„¤ì •ì„ í•  ìˆ˜ ìˆë‹¤. nginx.ingress.kubernetes.io/server-snippetì„ ì„¤ì •í•˜ë©´ Nginx ì„¤ì • íŒŒì¼ ë¬¸ë²•ì— ë”°ë¼ ìš”ì²­ í•„í„°ë§ ë“±ì„ ì‚¬ì´ì— ì¶”ê°€í•  ìˆ˜ ìˆë‹¤.

ìœ„ ì˜ˆì œ ê°™ì€ ê²½ìš° User-Agent ê°’ì— Mobileì´ í¬í•¨ëœ ê²½ìš° ìš”ì²­ì„ ë‹¤ë¥¸ URLë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ëŠ” ê²ƒì´ë‹¤. ì´ëŸ° ìš”ì²­ ì œì–´ë¥¼ ì¸ê·¸ë ˆìŠ¤ì—ì„œ ì²˜ë¦¬í•  ìˆ˜ ìˆê¸° ë–„ë¬¸ì— ë°±ì—”ë“œë‚˜ ì›¹ ì„œë²„, ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë²„ì—ì„œ ì´ë¥¼ ì‹ ê²½ ì“¸ í•„ìš”ê°€ ì—†ë‹¤.

í¼ë¸”ë¦­ í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œ ì¸ê·¸ë ˆìŠ¤ëŠ” í•´ë‹¹ í”Œë«í¼ì˜ L7 ë¡œë“œ ë°¸ëŸ°ì„œë¥¼ ì´ìš©í•  ìˆ˜ ìˆë‹¤. GCPì—ì„œëŠ” Cloud Load Balancingì„ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©í•˜ë©° AWSì—ì„œëŠ” Application Load Balancerë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

ë‹¤ìŒ ì¥ì—ì„œëŠ” ì´ëŸ¬í•œ í¼ë¸”ë¦­ í´ë¼ìš°ë“œë¥¼ ì‚¬ìš©í•´ ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ ì´ìš©í•œ ì¢€ ë” ì‹¤ì „ì ì¸ ì˜ˆì œë¥¼ ê°€ì§€ê³  ë‹¤ë£¨ë„ë¡ í•˜ê² ë‹¤.

<br><br><br><br><br><br><br><br><br><br>

**ì°¸ê³ **

[ë„ì»¤/ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ í™œìš©í•œ ì»¨í…Œì´ë„ˆ ê°œë°œ ì‹¤ì „ ì…ë¬¸](http://www.yes24.com/Product/Goods/70893433)