---
title: "[Kubernets/μΏ λ²„λ„¤ν‹°μ¤] 02. μΏ λ²„λ„¤ν‹°μ¤ μ…λ¬Έ - νλ“(Pod),λν”λ¦¬μΉ΄μ„ΈνΈ(ReplicaSet),λ””ν”λ΅μ΄λ¨ΌνΈ(Deployment),μ„λΉ„μ¤(Service)"
date: 2020-09-11T15:49:19+09:00

---

# π•Έ μΏ λ²„λ„¤ν‹°μ¤ μ…λ¬Έ - νλ“(Pod),λν”λ¦¬μΉ΄μ„ΈνΈ(ReplicaSet),λ””ν”λ΅μ΄λ¨ΌνΈ(Deployment),μ„λΉ„μ¤(Service) π•Έ


## νλ“

νλ“(pod)λ” μ»¨ν…μ΄λ„κ°€ λ¨μΈ μ§‘ν•©μ²΄μ λ‹¨μ„λ΅, μ μ–΄λ„ ν•λ‚ μ΄μƒμ μ»¨ν…μ΄λ„λ΅ μ΄λ£¨μ–΄μ§„λ‹¤. μΏ λ²„λ„¤ν‹°μ¤λ¥Ό λ„μ»¤μ™€ ν•¨κ» μ‚¬μ©ν•λ‹¤λ©΄ νλ“λ” μ»¨ν…μ΄λ„ ν•λ‚ νΉμ€ μ»¨ν…μ΄λ„μ μ§‘ν•©μ²΄κ°€ λλ‹¤. μΏ λ²„λ„¤ν‹°μ¤μ—μ„λ” κ²°ν•©μ΄ κ°•ν• μ»¨ν…μ΄λ„λ¥Ό νλ“λ΅ λ¬¶μ–΄ μΌκ΄„ λ°°ν¬ν•λ‹¤.

νλ“λ” λ‹¤μ κ·Έλ¦Όμ—μ„ λ³΄λ“―μ΄ λ…Έλ“μ— λ°°μΉν•΄μ•Ό ν•λ‹¤. κ°™μ€ νλ“λ¥Ό μ—¬λ¬ λ…Έλ“μ— λ°°μΉν•  μλ„ μκ³  ν• λ…Έλ“μ— μ—¬λ¬ κ° λ°°μΉν•  μλ„ μλ‹¤. κ·Έλ¬λ‚ νλ“ ν•λ‚κ°€ μ—¬λ¬ λ…Έλ“μ— κ±Έμ³ λ°°μΉλ  μλ” μ—†λ‹¤.

![image](https://www.slipp.net/wiki/download/attachments/41583706/image2019-9-16_15-33-53.png?version=1&modificationDate=1568624763000&api=v2)

<br>

#### νλ“ μƒμ„± λ° λ°°ν¬ν•κΈ°

κ·ΈλΌ μ΄μ  νλ“λ¥Ό μƒμ„±ν•΄ λ°°ν¬ν•΄ λ³΄μ. nginx-proxyμ™€ μ• ν”λ¦¬μΌ€μ΄μ…, 2κ°μ μ»¨ν…μ΄λ„λ¥Ό ν¬ν•¨ν•λ” νλ“λ¥Ό λ΅μ»¬ μΏ λ²„λ„¤ν‹°μ¤ ν™κ²½μ— λ°°ν¬ν•΄ λ³΄μ.

νλ“ μƒμ„±μ€ kubectlλ§ μ‚¬μ©ν•΄λ„ κ°€λ¥ν•μ§€λ§, λ²„μ „ κ΄€λ¦¬ κ΄€μ μ—μ„λ„ yaml νμΌλ΅ μ •μν•λ” κ²ƒμ΄ μΆ‹λ‹¤. μΏ λ²„λ„¤ν‹°μ¤μ μ—¬λ¬ κ°€μ§€ λ¦¬μ†μ¤λ¥Ό μ •μν•λ” νμΌμ„ **λ§¤λ‹νμ¤νΈ νμΌ** μ΄λΌκ³  ν•λ‹¤. niginxμ™€ echoλΌλ” μ• ν”λ¦¬μΌ€μ΄μ… λ‘ μ»¨ν…μ΄λ„λ΅ κµ¬μ„±λλ” νλ“λ¥Ό μ •μν• λ§¤λ‹νμ¤νΈ νμΌμ„ simple-pod.yamlμ΄λΌλ” μ΄λ¦„μΌλ΅ λ‹¤μκ³Ό κ°™μ΄ μ‘μ„±ν•λ‹¤.

~~~yaml
apiVersion: v1
kind: Pod
metadata: 
  name: simple-echo
spec:
  containers:
  - name: nginx
    image: gihyodocker/nginx:latest
    env:
    - name: BACKEND_HOST
      value: localhost:8080
    ports:
    - containerPort: 80
  - name: echo
    image: gihyodocker/echo:latest
    ports:
    - containerPort: 8080
~~~

μ΄ μ„¤μ • νμΌμ λ‚΄μ©μ„ μ„¤λ…ν•κ² λ‹¤.

**kind**λ” μ΄ νμΌμ—μ„ μ •μν•λ” μΏ λ²„λ„¤ν‹°μ¤ λ¦¬μ†μ¤μ μ ν•μ„ μ§€μ •ν•λ” μ†μ„±μ΄λ‹¤. kind μ†μ„±μ κ°’μ— λ”°λΌ spec μ•„λμ μ¤ν‚¤λ§κ°€ λ³€ν™”ν•λ‹¤.

**metadata**λ” μ΄λ¦„ κ·Έλ€λ΅ λ¦¬μ†μ¤μ— λ¶€μ—¬λλ” λ©”νƒ€λ°μ΄ν„°λ‹¤. medatadata.name μ†μ„±μ κ°’μ΄ μ΄ λ¦¬μ†μ¤μ μ΄λ¦„μ΄ λλ‹¤.

**spec**μ€ λ¦¬μ†μ¤λ¥Ό μ •μν•κΈ° μ„ν• μ†μ„±μΌλ΅, νλ“μ κ²½μ° νλ“λ¥Ό κµ¬μ„±ν•λ” μ»¨ν…μ΄λ„λ¥Ό containers μ•„λμ— μ •μν•λ‹¤.

**name**μ€ μ»¨ν…μ΄λ„ μ΄λ¦„, **image**λ” λ„μ»¤ ν—λΈμ— μ €μ¥λ μ΄λ―Έμ§€ νƒκ·Έκ°’μ„ μ§€μ •ν•λ‹¤.

**ports** μ†μ„±μ€ μ»¨ν…μ΄λ„κ°€ λ…Έμ¶μ‹ν‚¬(EXPOSE) ν¬νΈλ¥Ό μ§€μ •ν•λ‹¤.

**env** μ†μ„±μ— ν™κ²½ λ³€μλ¥Ό μ—΄κ±°ν•  μ μλ‹¤. nginxλ” μ”μ²­μ ν”„λ΅μ‹± λ€μƒμ΄ λ  BACKEND_HOST κ°’μ΄ ν•„μ”ν•κΈ° λ•λ¬Έμ— μ΄ κ°’μ΄ μ„¤μ •λΌ μλ‹¤.

μ΄ νλ“λ¥Ό λ΅μ»¬ μΏ λ²„λ„¤ν‹°μ¤ ν΄λ¬μ¤ν„°μ— λ°°ν¬ν•΄ λ³΄κ² λ‹¤. λ§¤λ‹νμ¤νΈ νμΌμ λ‚΄μ©μ„ κ·Έλ€λ΅ λ°μ—¬ν•λ ¤λ©΄ λ‹¤μκ³Ό κ°™μ΄ kubectlμ—μ„ -f μµμ…μΌλ΅ λ§¤λ‹νμ¤νΈ νμΌμ— λ€ν• κ²½λ΅λ¥Ό μ§€μ •ν•κ³  apply λ…λ Ήμ„ μ‚¬μ©ν•λ‹¤.

~~~
$ kubectl apply -f simple-pod.yaml
pod/simple-echo created
~~~

μ΄μ  νλ“κ°€ λ™μ‘ν•κΈ°λ” ν•μ§€λ§, μ•„μ§μ€ μ ‘κ·Όν•  μ μ—†λ‹¤. νλ“μ— μ ‘κ·Όν•λ” λ°©λ²•μ€ μ μ‹ ν›„μ— λ‹¤λ£¨λ„λ΅ ν•κ² λ‹¤.

<br>

#### νλ“ λ‹¤λ£¨κΈ°

λ§¤λ‹νμ¤νΈ νμΌλ΅ νλ“λ¥Ό μƒμ„±ν–λ‹¤. μ΄λ²μ—λ” νλ“λ¥Ό μ΅°μ‘ν•λ” κΈ°λ³Έ λ°©λ²•μ„ μ•μ•„λ³Έλ‹¤. 

νλ“μ μƒνƒλ” λ‹¤μκ³Ό κ°™μ΄ λ©λ΅μ—μ„ ν™•μΈν•  μ μλ‹¤. STATUSκ°€ Runningμ΄λ©΄ νλ“ μ•μ λ¨λ“  μ»¨ν…μ΄λ„κ°€ μ‹¤ν–‰ μ¤‘μ΄λΌλ” μλ―Έλ‹¤. READY μΉΌλΌκ°’μ λ¶„λ¨λ” νλ“μ— μ •μλ μ»¨ν…μ΄λ„ μμ΄κ³  λ¶„μλ” μ‹¤ν–‰ μ‹¤ν–‰ μƒνƒμ μ»¨ν…μ΄λ„ μμ΄λ‹¤.

~~~
$ kubectl get pod
NAME          READY   STATUS    RESTARTS   AGE
simple-echo   2/2     Running   0          35m
~~~

kubectlμ„ μ‚¬μ©ν•΄ **μ»¨ν…μ΄λ„ μ•μ— μ ‘κ·Ό** ν•  μλ„ μλ‹¤. νλ“ μ•μ μ»¨ν…μ΄λ„κ°€ μ—¬λ¬ κ°μΈ κ²½μ°μ—λ” -c μµμ…μ— μ»¨ν…μ΄λ„ λ…μ„ μ§€μ •ν•λ‹¤.

~~~
$ kubectl exec -it simple-echo -c nginx /bin/bash
root@simple-echo:/#     
~~~

**kubectl log λ…λ Ή** μΌλ΅ νλ“ μ•μ— μλ” μ»¨ν…μ΄λ„μ ν‘μ¤€ μ¶λ ¥μ„ ν™”λ©΄μ— μ¶λ ¥ν•  μ μλ‹¤. λ§μ°¬κ°€μ§€λ΅ -c μµμ…μΌλ΅ μ»¨ν…μ΄λ„λ…μ„ μ§€μ •ν•λ‹¤.

~~~
$ kubectl logs -f simple-echo -c echo
2020/09/09 14:00:56 start server
~~~

νλ“λ¥Ό μ‚­μ ν•λ ¤λ©΄ kubectl delete pod λ…λ Ήμ„ μ‚¬μ©ν•λ‹¤. kubectl delete λ…λ Ήμ€ νλ“ μ™Έμ— λ¦¬μ†μ¤μ—λ„ μ ν¨ν•λ‹¤. λν• λ§¤λ‹νμ¤νΈ νμΌλ΅ νλ“λ¥Ό μ‚­μ ν•  μ μλ”λ°, μ΄ κ²½μ°μ—λ” λ§¤λ‹νμ¤νΈμ— μ‘μ„±λ λ¦¬μ†μ¤ μ „μ²΄κ°€ μ‚­μ λλ‹¤.

~~~
$ kubectl delete pod simple-echo
~~~

~~~
$ kubectl delte -f simple-pod.yaml
~~~

<br><br>

## λ ν”λ¦¬μΉ΄μ„ΈνΈ

νλ“λ¥Ό μ •μν• λ§¤λ‹νμ¤νΈ νμΌλ΅λ” νλ“λ¥Ό ν•λ‚λ°–μ— μƒμ„±ν•  μ μ—†λ‹¤. κ·Έλ¬λ‚ μ–΄λ μ •λ„ κ·λ¨κ°€ λλ” μ• ν”λ¦¬μΌ€μ΄μ…μ„ κµ¬μ¶•ν•λ ¤λ©΄ κ°™μ€ νλ“λ¥Ό μ—¬λ¬ κ° μ‹¤ν–‰ν•΄ κ°€μ©μ„±μ„ ν™•λ³΄ν•΄μ•Ό ν•λ” κ²½μ°κ°€ μƒκΈ΄λ‹¤.

μ΄λ° κ²½μ°μ— μ‚¬μ©λλ” κ²ƒμ΄ **λν”λ¦¬μΉ΄μ„ΈνΈ(ReplicaSet)** λ‹¤. λν”λ¦¬μΉ΄ μ„ΈνΈλ” λ‘κ°™μ€ μ •μλ¥Ό κ°–λ” νλ“λ¥Ό μ—¬λ¬ κ° μƒμ„±ν•κ³  κ΄€λ¦¬ν•κΈ° μ„ν• λ¦¬μ†μ¤λ‹¤. νλ“μ μ •μ μμ²΄λ„ λ ν”λ¦¬μΉ΄ μ„ΈνΈλ¥Ό μ •μν• yaml νμΌμ— μ‘μ„±ν•λ―€λ΅ νλ“μ μ„¤μ • νμΌμ„ λ”°λ΅ λ‘ ν•„μ” μ—†μ΄ νμΌ ν•λ‚λ΅ μ •μλ¥Ό μ™„κ²°μ§€μ„ μ μλ‹¤. κ·Έλ¬λ©΄ simple-replicaset.yamlμ„ μ‘μ„±ν•΄λ³΄μ.

~~~yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: echo
  labels:
    app: echo
spec:
  replicas: 3
  selector:
    matchLabels:
      app: echo
  template:
    metadata: 
      labels: 
        app: echo
    spec:
      containers:
      - name: nginx
        image: gihyodocker/nginx:latest
        env:
        - name: BACKEND_HOST
          value: localhost:8080
        ports:
        - containerPort: 80
      - name: echo
        image: gihyodocker/echo:latest
        ports:
        - containerPort: 8080
~~~

**replicas**λ” λ ν”λ¦¬μΉ΄μ„ΈνΈμ—μ„ λ§λ“¤ νλ“μ λ³µμ λ³Έ μλ‹¤. κ·Έλ¦¬κ³  **template** μ†μ„±μ λ‚΄μ©μ€ νλ“ μ •μμ™€ κ°™λ‹¤. μ΄ λ ν”λ¦¬μΉ΄μ„ΈνΈλ¥Ό λ°°ν¬ν•λ©΄ νλ“κ°€ 3κ° λ§λ“¤μ–΄μ§„ κ²ƒμ„ ν™•μΈν•  μ μλ‹¤. κ°™μ€ νλ“κ°€ μ—¬λΏ λ³µμ λ κ²ƒμ΄λ―€λ΅ νλ“λ…μ— echo-xxxμ²λΌ λ¬΄μ‘μ„λ΅ μƒμ„±λ μ ‘λ―Έμ‚¬κ°€ λ¶™λ”λ‹¤.

~~~
$ kubectl apply -f simple-replicaset.yaml
replicaset.apps/echo created
~~~

~~~
$ kubectl get pod
NAME          READY   STATUS    RESTARTS   AGE
echo-2sf2h    2/2     Running   0          45s
echo-q76w2    2/2     Running   0          45s
echo-tlknw    2/2     Running   0          45s
~~~

λ ν”λ¦¬μΉ΄μ„ΈνΈλ¥Ό μ΅°μ‘(yaml νμΌμ„ μμ •) νλ“μ μλ¥Ό μ¤„μ΄λ©΄ μ¤„μΈ κ°μλ§νΌ νλ“κ°€ μ‚­μ λλ‹¤. μ‚­μ λ νλ“λ” λ³µμ›ν•  μ μ—†κΈ° λ•λ¬Έμ— μ›Ή μ• ν”λ¦¬μΌ€μ΄μ… κ°™μ€ stateless νλ“λ¥Ό μ‚¬μ©ν•κΈ°μ— μ λ¦¬ν•λ‹¤.

μƒμ„±ν• λ ν”λ¦¬μΉ΄μ„ΈνΈλ¥Ό λ§¤λ‹νμ¤νΈ νμΌμ„ μ΄μ©ν•΄ λ‹¤μκ³Ό κ°™μ΄ μ‚­μ κ°€ κ°€λ¥ν•λ‹¤.

~~~
$ kubectl delete -f simple-replicaset.yaml
replicaset.apps "echo" deleted

$ kubectl get pod
NAME          READY   STATUS        RESTARTS   AGE
echo-2sf2h    2/2     Terminating   0          5m18s
echo-q76w2    2/2     Terminating   0          5m18s
echo-tlknw    2/2     Terminating   0          5m18s
~~~

<br><br>

## λ””ν”λ΅μ΄λ¨ΌνΈ

λ ν”λ¦¬μΉ΄μ„ΈνΈλ³΄λ‹¤ μƒμ„μ— ν•΄λ‹Ήν•λ” λ¦¬μ†μ¤λ΅ **λ””ν”λ΅μ΄λ¨ΌνΈ(deployment)**κ°€ μλ‹¤. λ””ν”λ΅μ΄λ¨ΌνΈλ” μ• ν”λ¦¬μΌ€μ΄μ… λ°°ν¬(deploy)μ κΈ°λ³Έ λ‹¨μ„κ°€ λλ” λ¦¬μ†μ¤λ‹¤. λν• λ””ν”λ΅μ΄λ¨ΌνΈλ” λ ν”λ¦¬μΉ΄μ„ΈνΈλ¥Ό κ΄€λ¦¬ν•κ³  λ‹¤λ£¨κΈ° μ„ν• λ¦¬μ†μ¤λ‹¤.

νλ“, λ ν”λ¦¬μΉ΄μ„ΈνΈ, λ””ν”λ΅μ΄λ¨ΌνΈμ κ΄€κ³„λ¥Ό μ •λ¦¬ν•λ©΄ λ‹¤μ κ·Έλ¦Όκ³Ό κ°™λ‹¤.

![image](https://www.bluematador.com/hs-fs/hubfs/blog/new/Kubernetes%20Deployments%20-%20Rolling%20Update%20Configuration/Deployment%20Diagrams%20-%20static.png?width=600&name=Deployment%20Diagrams%20-%20static.png)

μ¶μ² : https://www.bluematador.com/blog/kubernetes-deployments-rolling-update-configuration

<br>

λ””ν”λ΅μ΄λ¨ΌνΈλ¥Ό μ •μν• λ§¤λ‹νμ¤νΈ νμΌ simple-deployment.yamlμ„ λ‹¤μκ³Ό κ°™μ΄ μ‘μ„±ν•λ‹¤

~~~yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: echo
  labels:
    app: echo
spec:
  replicas: 3
  selector:
    matchLabels:
      app: echo
  template:
    metadata: 
      labels: 
        app: echo
    spec:
      containers:
      - name: nginx
        image: gihyodocker/nginx:latest
        env:
        - name: BACKEND_HOST
          value: localhost:8080
        ports:
        - containerPort: 80
      - name: echo
        image: gihyodocker/echo:latest
        ports:
        - containerPort: 8080
~~~

λ””ν”λ΅μ΄λ¨ΌνΈμ μ •μλ” λ ν”λ¦¬μΉ΄μ„ΈνΈμ μ •μμ™€ ν¬κ² λ‹¤λ¥΄μ§€ μ•λ‹¤. μ°¨μ΄κ°€ μλ‹¤λ©΄ λ””ν”λ΅μ΄λ¨ΌνΈκ°€ λ ν”λ¦¬μΉ΄μ„ΈνΈμ λ¦¬λΉ„μ „ κ΄€λ¦¬λ¥Ό ν•  μ μλ‹¤λ” μ  μ •λ„λ‹¤.

μ΄ λ§¤λ‹νμ¤νΈ νμΌμ„ μ–΄λ–¤ kubectl λ…λ Ήμ„ μ‹¤ν–‰ν–λ”μ§€ κΈ°λ΅μ„ λ‚¨κΈ°λ” μµμ…μΈ **--record**λ¥Ό λ¶™μ—¬ kubectlλ΅ ν΄λ¬μ¤ν„°μ— λ°μν•λ‹¤.

~~~
$ kubectl apply -f simple-deployment.yaml --record
deployment.apps/echo created
~~~

kubectl λ…λ ΉμΌλ΅ μƒνƒλ¥Ό ν™•μΈν•΄ λ³΄μ. λ””ν”λ΅μ΄λ¨ΌνΈλ” λ¬Όλ΅ μ΄κ³ , λ ν”λ¦¬μΉ΄μ„ΈνΈμ™€ νλ“κ°€ μƒμ„±λ κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.

~~~
$ kubectl get pod,replicaset,deployment --selector app=echo
NAME                        READY   STATUS    RESTARTS   AGE
pod/echo-59dfb6bdf7-7lg62   2/2     Running   0          2m1s
pod/echo-59dfb6bdf7-wj8k6   2/2     Running   0          2m1s
pod/echo-59dfb6bdf7-xvwkc   2/2     Running   0          2m1s

NAME                              DESIRED   CURRENT   READY   AGE
replicaset.apps/echo-59dfb6bdf7   3         3         3       2m1s

NAME                   READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/echo   3/3     3            3           2m1s
choeminseong-ui-MacBook-Pro:04.docekr_pod choeminseong$ 
~~~

λ””ν”λ΅μ΄λ¨ΌνΈμ λ¦¬λΉ„μ „μ€ λ‹¤μκ³Ό κ°™μ΄ kubectl rollout history λ…λ ΉμΌλ΅ ν™•μΈν•  μ μλ‹¤. ν„μ¬λ” μ²«λ²μ§Έ λ°μμ΄λ―€λ΅ REVISION=1μ΄λ‹¤.

~~~
$ kubectl rollout history deployment echo
deployment.apps/echo 
REVISION  CHANGE-CAUSE
1         kubectl apply --filename=simple-deployment.yaml --record=true
~~~

### λ ν”λ¦¬μΉ΄μ„ΈνΈμ μƒμ• μ£ΌκΈ°

μ‹¤μ  μ΄μμ—μ„ μΏ λ²„λ„¤ν‹°μ¤λ” λ””ν”λ΅μ΄λ¨ΌνΈλ¥Ό λ‹¨μ„λ΅ μ• ν”λ¦¬μΌ€μ΄μ…μ„ λ°°ν¬ν•λ‹¤. λ””ν”λ΅μ΄λ¨ΌνΈκ°€ κ΄€λ¦¬ν•λ” λ ν”λ¦¬μΉ΄μ„ΈνΈλ” μ§€μ •λ κ°μλ§νΌ νλ“λ¥Ό ν™•λ³΄ν•κ±°λ‚ νλ“λ¥Ό μƒλ΅μ΄ λ²„μ „μΌλ΅ κµμ²΄ν•κ±°λ‚ μ΄μ „ λ²„μ „μΌλ΅ λ΅¤λ°±ν•λ” λ“± μ¤‘μ”ν• μ—­ν• μ„ ν•λ‹¤. κ·Έλ¬λ―€λ΅ μ• ν”λ¦¬μΌ€μ΄μ… λ°°ν¬λ¥Ό λ°”λ¥΄κ² μ΄μν•λ ¤λ©΄ λ””ν”λ΅μ΄λ¨ΌνΈ μ•μ—μ„ λ ν”λ¦¬μΉ΄μ„ΈνΈκ°€ μ–΄λ–»κ² λ™μ‘ν•λ”μ§€ νμ•…ν•  μ μμ–΄μ•Ό ν•λ‹¤. λ””ν”λ΅μ΄λ¨ΌνΈλ¥Ό μμ •ν•λ©΄ λ ν”λ¦¬μΉ΄μ„ΈνΈκ°€ μƒλ΅ μƒμ„±λκ³  κΈ°μ΅΄ λ ν”λ¦¬μΉ΄μ„ΈνΈμ™€ κµμ²΄λλ‹¤.

μ–΄λ–¤ κ²½μ°μ— μƒ λ ν”λ¦¬μΉ΄μ„ΈνΈκ°€ μƒμ„±λλ”μ§€ μ‚΄ν΄λ³΄μ.

#### νλ“ κ°μλ§ μμ •ν•λ©΄ λ ν”λ¦¬μΉ΄μ„ΈνΈκ°€ μƒλ΅ μƒμ„±λμ§€ μ•μ

μ°μ„± νλ“ κ°μλ§μ„ μμ •ν•΄ λ³΄κ² λ‹¤. λ§¤λ‹νμ¤νΈ νμΌμ—μ„ replicas κ°’μ„ 3μ—μ„ 4λ΅ μμ •ν•΄ λ°μν•κ³  μ μ©ν•΄λ³΄μ.

~~~
# κ°μ λ°μ μ „ #

$ kubectl get pod
NAME                    READY   STATUS    RESTARTS   AGE
echo-59dfb6bdf7-7lg62   2/2     Running   0          17m
echo-59dfb6bdf7-wj8k6   2/2     Running   0          17m
echo-59dfb6bdf7-xvwkc   2/2     Running   0          17m
~~~

λ‹¤μμ—μ„ λ³΄λ“―μ΄ μ›λ μλ νλ“λ” κ·Έλ€λ΅ μκ³ , μ»¨ν…μ΄λ„κ°€ ν•λ‚ μƒλ΅ μƒμ„±λ κ²ƒμ„ μ• μ μλ‹¤.

~~~
# κ°μ λ°μ ν›„ #

$ kubectl apply -f simple-deployment.yaml --record
deployment.apps/echo configured

$ kubectl get pod
NAME                    READY   STATUS    RESTARTS   AGE
echo-59dfb6bdf7-7lg62   2/2     Running   0          17m
echo-59dfb6bdf7-c47zf   2/2     Running   0          16s
echo-59dfb6bdf7-wj8k6   2/2     Running   0          17m
echo-59dfb6bdf7-xvwkc   2/2     Running   0          17m
~~~

λ ν”λ¦¬μΉ΄μ„ΈνΈκ°€ μƒλ΅ μƒμ„±λλ‹¤λ©΄ λ¦¬λΉ„μ „ λ²νΈκ°€ 2μΌ ν…λ°, κ·Έ λ‚΄μ©μ€ μ¶λ ¥λμ§€ μ•λ”λ‹¤. replicas κ°’λ§ λ³€κ²½ν•΄μ„λ” λ ν”λ¦¬μΉ΄μ„ΈνΈμ κµμ²΄κ°€ μΌμ–΄λ‚μ§€ μ•λ”λ‹¤λ” κ²ƒμ„ μ• μ μλ‹¤.

~~~
$ kubectl rollout history deployment echo
deployment.apps/echo 
REVISION  CHANGE-CAUSE
1         kubectl apply --filename=simple-deployment.yaml --record=true
~~~

#### μ»¨ν…μ΄λ„ μ •μ μμ •

μ»¨ν…μ΄λ„ μ΄λ―Έμ§€κ°€ μμ •λ κ²½μ°λ¥Ό ν™•μΈν•΄ λ³΄μ, simple-deployment.yaml νμΌμ echo μ»¨ν…μ΄λ„ μ΄λ―Έμ§€λ¥Ό λ‹¤μκ³Ό κ°™μ΄ gihyodocker/echo:patcedλ΅ μμ •ν•λ‹¤.
~~~yaml
 - name: echo
        image: gihyodocker/echo:patched
        ports:
        - containerPort: 8080
~~~

~~~
$ kubectl apply -f simple-deployment.yaml --record
deployment.apps/echo configured
~~~

κ·Έλ¬λ©΄ λ‹¤μκ³Ό κ°™μ΄ μƒλ΅μ΄ νλ“κ°€ μƒμ„±λκ³  κΈ°μ΅΄ νλ“λ” λ‹¨κ³„μ μΌλ΅ μ •μ§€λ¨μ„ μ• μ μλ‹¤.

~~~
$ kubectl get pod --selector app=echo
NAME                    READY   STATUS        RESTARTS   AGE
echo-59dfb6bdf7-7lg62   2/2     Terminating   0          22m
echo-59dfb6bdf7-wj8k6   0/2     Terminating   0          22m
echo-6c77cf9d47-8gq2m   2/2     Running       0          38s
echo-6c77cf9d47-fc82h   2/2     Running       0          34s
echo-6c77cf9d47-nwnrp   2/2     Running       0          50s
echo-6c77cf9d47-wlxgn   2/2     Running       0          49s
~~~

λ””ν”λ΅μ΄λ¨ΌνΈμ λ¦¬λΉ„μ „μ„ ν™•μΈν•΄ λ³΄λ©΄ REVISION=2κ°€ μƒμ„±λλ‹¤. kubectl applyλ¥Ό μ‹¤ν–‰ν–μ„ λ–„ λ””ν”λ΅μ΄λ¨ΌνΈμ λ‚΄μ©μ΄ λ³€κ²½λ κ²½μ° μƒλ΅μ΄ λ¦¬λΉ„μ „μ΄ μƒμ„±λλ‹¤.

~~~
$ kubectl rollout history deployment echo
deployment.apps/echo 
REVISION  CHANGE-CAUSE
1         kubectl apply --filename=simple-deployment.yaml --record=true
2         kubectl apply --filename=simple-deployment.yaml --record=true
~~~

<br>

### λ΅¤λ°± μ‹¤ν–‰ν•κΈ°

λ””ν”λ΅μ΄λ¨ΌνΈλ” λ¦¬λΉ„μ „ λ²νΈκ°€ κΈ°λ΅λλ―€λ΅ νΉμ • λ¦¬λΉ„μ „μ λ‚΄μ©μ„ ν™•μΈν•  μ μλ‹¤.

~~~
$ kubectl rollout history deployment echo --revision=1
deployment.apps/echo with revision #1
Pod Template:
  Labels:	app=echo
	pod-template-hash=59dfb6bdf7
  Annotations:	kubernetes.io/change-cause: kubectl apply --filename=simple-deployment.yaml --record=true
  Containers:
   nginx:
    Image:	gihyodocker/nginx:latest
    Port:	80/TCP
    Host Port:	0/TCP
    Environment:
      BACKEND_HOST:	localhost:8080
    Mounts:	<none>
   echo:
    Image:	gihyodocker/echo:latest
    Port:	8080/TCP
    Host Port:	0/TCP
    Environment:	<none>
    Mounts:	<none>
  Volumes:	<none>
~~~

**undo**λ¥Ό μ‹¤ν–‰ν•λ©΄ λ””ν”λ΅μ΄λ¨ΌνΈκ°€ λ°”λ΅ μ§μ „ λ¦¬λΉ„μ „μΌλ΅ λ΅¤λ°±λλ‹¤.

~~~
$ kubectl rollout undo deployment echo
deployment.apps/echo rolled back
choeminseong-ui-MacBook-Pro:04.docekr_pod 
~~~

λ””ν”λ΅μ΄λ¨ΌνΈλ” λ‹¤μκ³Ό κ°™μ΄ λ§¤λ‹νμ¤νΈ νμΌμ„ μ΄μ©ν•΄μ„ μ‚­μ ν•λ‹¤. λ””ν”λ΅μ΄λ¨ΌνΈ λ° κ΄€λ ¨λ λ ν”λ¦¬μΉ΄μ„ΈνΈμ™€ νλ“κ°€ ν•¨κ» μ‚­μ λλ‹¤.

~~~
$ kubectl delete -f simple-deployment.yaml
deployment.apps "echo" deleted
~~~

<br><br>

## μ„λΉ„μ¤

μ„λΉ„μ¤λ” μΏ λ²„λ„¤ν‹°μ¤ ν΄λ¬μ¤ν„° μ•μ—μ„ νλ“μ μ§‘ν•©(μ£Όλ΅ λ ν”λ¦¬μΉ΄μ„ΈνΈ)μ— λ€ν• κ²½λ΅λ‚ μ„λΉ„μ¤ λ””μ¤μ»¤λ²„λ¦¬(API μ£Όμ†κ°€ λ™μ μΌλ΅ λ°”λ€λ” κ²½μ°μ—λ„ ν΄λΌμ΄μ–ΈνΈκ°€ μ ‘μ† λ€μƒμ„ λ°”κΎΈμ§€ μ•κ³  ν•λ‚μ μ΄λ¦„μΌλ΅ μ ‘κ·Όν•  μ μλ„λ΅ ν•λ” κΈ°λ¥)λ¥Ό μ κ³µν•λ” λ¦¬μ†μ¤λ‹¤. μ„λΉ„μ¤μ λ€μƒμ΄ λλ” νλ“λ” μ„λΉ„μ¤μ—μ„ μ •μν•λ” λ μ΄λΈ” μ…€λ ‰ν„°λ΅ μ •ν•΄μ§„λ‹¤.

μλ¥Ό λ“¤μ–΄, simple-replicaset-with-label.yamlμ΄λΌλ” μ΄λ¦„μΌλ΅ λ‹¤μκ³Ό κ°™μ€ λ§¤λ‹νμ¤νΈ νμΌμ„ μ‘μ„±ν•΄ λ ν”λ¦¬μΉ΄μ„ΈνΈλ¥Ό 2κ° μ •μν•λ‹¤. μ•μ„ μ •μν–λ echo λ ν”λ¦¬μΉ΄μ„ΈνΈμ™€ κ±°μ κ°™μΌλ‚, release μ†μ„±κ°’κ³Ό springκ³Ό summerλ΅ λ‚λ‰λ‹¤.

~~~yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: echo-spring
  labels:
    app: echo
    release: spring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: echo
      release: spring
  template:
    metadata:
      labels:
        app: echo
        release: spring
    spec:
      containers:
      - name: nginx
        image: gihyodocker/nginx:latest
        env:
        - name: BACKEND_HOST
          value: localhost:8080
        ports:
        - containerPort: 80
      - name: echo
        image: gihyodocker/echo:latest
        ports:
        - containerPort: 8080

---

apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: echo-summer
  labels:
    app: echo
    release: summer
spec:
  replicas: 2
  selector:
    matchLabels:
      app: echo
      release: summer
  template:
    metadata:
      labels:
        app: echo
        release: summer
    spec:
      containers:
      - name: nginx
        image: gihyodocker/nginx:latest
        env:
        - name: BACKEND_HOST
          value: localhost:8080
        ports:
        - containerPort: 80
      - name: echo
        image: gihyodocker/echo:latest
        ports:
        - containerPort: 8080
~~~

~~~
$ kubectl apply -f simple-replicaset-with-label.yaml
replicaset.apps/echo-spring created
replicaset.apps/echo-summer created


$ kubectl get pod -l app=echo -l release=spring
NAME                READY   STATUS    RESTARTS   AGE
echo-spring-5fp66   2/2     Running   0          75s

$ kubectl get pod -l app=echo -l release=summer
NAME                READY   STATUS    RESTARTS   AGE
echo-summer-nff8t   2/2     Running   0          78s
echo-summer-zkrkg   2/2     Running   0          78s
~~~

release=summerμΈ νλ“λ§ μ ‘κ·Όν•  μ μλ” μ„λΉ„μ¤λ¥Ό μƒμ„±ν•΄ λ³΄μ. λ‹¤μκ³Ό κ°™μ΄ simple-service.yaml νμΌμ„ μ‘μ„±ν•λ‹¤. spec.selector μ†μ„±κ°’μΌλ΅ μ„λΉ„μ¤ λ€μƒμΌλ΅ μ‚Όμ„ νλ“μ λ μ΄λΈ”κ°’μ„ μ„¤μ •ν•λ‹¤.

~~~yaml
apiVersion: v1
kind: Service
metadata:
  name: echo
spec:
  selector:
    app: echo
    release: summer
  ports:
  - name: http
    port: 80
~~~

μ΄ μ„λΉ„μ¤μ™€ λ μ΄λΈ”λ΅ κµ¬λ¶„λλ” κ° νλ“μ κ΄€κ³„λ¥Ό λ‹¤μ κ·Έλ¦Όμ— λ‚νƒ€λƒλ‹¤. νλ‹¤μ λ μ΄λΈ”μ΄ μ„λΉ„μ¤μ— μ •μλ μ…€λ ‰ν„° κ°’κ³Ό μΌμΉν•λ©΄ ν•΄λ‹Ή νλ“λ” κ·Έ μ„λΉ„μ¤μ λ€μƒμ΄ λλ―€λ΅ μ„λΉ„μ¤λ¥Ό κ²½μ ν•΄ νΈλν”½μ΄ λ“¤μ–΄ μ¨λ‹¤.

![service](https://user-images.githubusercontent.com/50758600/92919192-176e3d00-f46b-11ea-8346-0db69753d45b.png)

simple-service.yamlμ„ λ°μν•΄ μ„λΉ„μ¤λ¥Ό μƒμ„±ν•λ‹¤.

~~~
$ kubectl apply -f simple-service.yaml
service/echo created

$ kubectl get svc echo
NAME   TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
echo   ClusterIP   10.97.4.73   <none>        80/TCP    19s
~~~

μ‹¤μ λ΅λ„ release=summerμΈ νλ“μ—λ§ νΈλν”½μ΄ μ „λ‹¬λλ”μ§€ ν™•μΈν•΄ λ³΄μ.

μ„λΉ„μ¤λ” κΈ°λ³Έμ μΌλ΅ μΏ λ²„λ„¤ν‹°μ¤ ν΄λ¬μ¤ν„° μ•μ—μ„λ§ μ ‘κ·Όν•  μ μλ‹¤. κ·Έλ¬λ―€λ΅ μΏ λ²„λ„¤ν‹°μ¤ ν΄λ¬μ¤ν„° μ•μ—μ„ λ””λ²„κΉ…μ© μ„μ‹ μ»¨ν…μ΄λ„λ¥Ό λ°°ν¬ν•κ³  curl λ…λ ΉμΌλ΅ HTTP μ”μ²­μ„ λ³΄λ‚΄ ν™•μΈν•΄ λ³Ό κ²ƒμ΄λ‹¤. λ””λ²„κ·Έ μ»¨ν…μ΄λ„μ— λ“¤μ–΄κ°€μ„ http://echo/ λ΅ μ•„λ¬΄λ ‡κ²λ‚ HTTP μ”μ²­μ„ λ³΄λ‚Έλ‹¤.

~~~
$ kubectl run -i --rm --tty debug --image=gihyodocker/fundamental:0.1.0 --restart=Never -- bash -il
If you don't see a command prompt, try pressing enter.
debug:/# curl http://echo/
Hello Docker!!debug:/# 
~~~

μ—¬κΈ°μ„ 'http://echo/' λ΅ μ ‘κ·Όμ΄ κ°€λ¥ν• μ΄μ λ” μΏ λ²„λ„¤ν‹°μ¤ ν΄λ¬μ¤ν„°μ DNSλ” μ„λΉ„μ¤λ¥Ό μ„λΉ„μ¤λ….λ„¤μ„μ¤νμ΄μ¤λ….svc.localλ΅ μ—°κ²°ν•΄μ¤€λ‹¤.

μλ¥Ό λ“¤μ–΄, μ„μ echosms default λ„¤μ„μ¤νμ΄μ¤μ— λ°°μΉλΌ μμΌλ―€λ΅ λ‹¤μκ³Ό κ°™λ‹¤.

> http://echo.default.svc.local

μ—¬κΈ°μ„ svc.local λ¶€λ¶„μ€ μƒλµν•  μ μκ³ , κ°™μ€ λ„¤μ„μ¤νμ΄μ¤λΌλ©΄ μ„λΉ„μ¤λ…λ§μΌλ΅ μ°Έμ΅°κ°€ κ°€λ¥ν•λ‹¤.

λ μ΄λΈ”μ΄ summerμΈ νλ“λ¥Ό ν•λ‚ κ³¨λΌ λ΅κ·Έλ¥Ό ν™•μΈν•΄ λ³΄λ©΄ "received request"κ°€ μ¶λ ¥λλ‹¤. λ°λ©΄ λ μ΄λΈ”μ΄ springμΈ νλ“λ” λ΅κ·Έκ°€ μ¶λ ¥λμ§€ μ•λ”λ‹¤.

~~~
$ kubectl logs -f echo-summer-zkrkg -c echo
2020/09/11 07:37:41 start server
2020/09/11 14:01:07 received request
~~~

<br>

#### ClusterIP μ„λΉ„μ¤

μ„λΉ„μ¤μ—λ„ μ—¬λ¬ κ°€μ§€ μΆ…λ¥κ°€ μμ–΄μ„ κ·Έ μΆ…λ¥λ¥Ό yaml νμΌμ—μ„ μ§€μ •ν•  μ μλ‹¤. μΆ…λ¥μ κΈ°λ³Έκ°’μ€ **ClusterIP μ„λΉ„μ¤** λ‹¤.

ClusterIP μ„λΉ„μ¤λ¥Ό μ‚¬μ©ν•λ©΄ μΏ λ²„λ„¤ν‹°μ¤ ν΄λ¬μ¤ν„°μ λ‚΄λ¶€ IP μ£Όμ†μ— μ„λΉ„μ¤λ¥Ό κ³µκ°ν•  μ μλ‹¤. μ΄λ¥Ό μ΄μ©ν•΄ μ–΄λ–¤ νλ“μ—μ„ λ‹¤λ¥Έ νλ“ κ·Έλ£ΉμΌλ΅ μ ‘κ·Όν•  λ–„ μ„λΉ„μ¤λ¥Ό κ±°μ³ κ°€λ„λ΅ ν•  μ μμΌλ©°, μ„λΉ„μ¤λ…μΌλ΅ λ„¤μ„ λ μ΅Έλ£¨μ…μ΄ κ°€λ¥ν•΄μ§„λ‹¤. λ‹¤λ§, μ™Έλ¶€λ΅λ¶€ν„°λ” μ ‘κ·Όμ΄ λ¶κ°€λ¥ν•λ‹¤.

#### NodePort μ„λΉ„μ¤

NodePort μ„λΉ„μ¤λ” ν΄λ¬μ¤ν„° μ™Έλ¶€μ—μ„ μ ‘κ·Όν•  μ μλ” μ„λΉ„μ¤λ‹¤.

NodePort μ„λΉ„μ¤λ” ClusterIPλ¥Ό λ§λ“ λ‹¤λ” μ μ€ ClusterIP μ„λΉ„μ¤μ™€ κ°™λ‹¤. κ° λ…Έλ“μ—μ„ μ„λΉ„μ¤ ν¬νΈλ΅ μ ‘μ†ν•κΈ° μ„ν• κΈ€λ΅λ² ν¬νΈλ¥Ό κ°λ°©ν•λ‹¤λ” μ μ΄ μ°¨μ΄μ μ΄λ‹¤.

~~~
apiVersion: v1
kind: Service
metadata:
  name: echo
spec:
  type: NodePort
  selector:
    app: echo
  ports:
  - name: http
    port: 80
~~~

~~~
$ kubectl apply -f simple-nodeport-service.yaml
service/echo configured
choeminseong-ui-MacBook-Pro:04.docekr_pod choe

$ kubectl get svc echo
NAME   TYPE       CLUSTER-IP   EXTERNAL-IP   PORT(S)        AGE
echo   NodePort   10.97.4.73   <none>        80:30727/TCP   115m
~~~

NodePort μ„λΉ„μ¤λ¥Ό μƒμ„±ν–λ‹¤λ©΄ μ„μ 80:30727/TCPλΌκ³  λ‚μ™”λ“―μ΄ λ…Έλ“μ ν¬νΈ 31058λ¥Ό ν†µν•΄ μ„λΉ„μ¤μ— μ ‘κ·Όν•  μ μλ‹¤. μ΄λ¥Ό μ΄μ©ν•΄ μ„λΉ„μ¤λ¥Ό κµ¬λ²„λ„¤ν‹°μ¤ ν΄λ¬μ¤ν„° μ™Έλ¶€λ΅ κ³µκ°ν•  μ μλ‹¤.

~~~
$ curl http://localhost:30727
Hello Docker!!
~~~

#### LoadBalancer μ„λΉ„μ¤





<br><br><br><br><br><br><br><br><br><br>

**μ°Έκ³ **

[λ„μ»¤/μΏ λ²„λ„¤ν‹°μ¤λ¥Ό ν™μ©ν• μ»¨ν…μ΄λ„ κ°λ° μ‹¤μ „ μ…λ¬Έ](http://www.yes24.com/Product/Goods/70893433)